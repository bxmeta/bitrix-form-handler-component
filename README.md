# Универсальный обработчик форм «victory:form.handler»

Современный и гибкий AJAX-компоннент для обработки любых веб-форм на 1С-Битрикс. Написан на ядре D7, работает в режиме контроллера, что обеспечивает быструю и безопасную обработку данных без перезагрузки страницы.

## Ключевые возможности

- **Работа на D7 и AJAX:** Быстрая обработка данных без перезагрузки страницы.
- **Гибкое хранение данных:** Поддержка сохранения результатов в **инфоблоки** и **Highload-блоки**.
- **Защита от спама:** Встроенная поддержка **Google reCAPTCHA v2** и **Yandex SmartCaptcha**.
- **Уведомления на почту:** Автоматическое создание и отправка почтовых событий при получении новых заявок.
- **Гибкая инте��рация с Bitrix24:** Создание **лидов** или **сделок** с гибкой настройкой соответствия полей формы и CRM.
- **Поддержка нескольких форм:** Корректная работа нескольких экземпляров компонента на одной странице благодаря динамической генерации ID.
- **Расширяемость:** Кастомные события `OnBeforeFormSave` и `OnAfterFormSave` для дополнительной обработки данных.
- **Безопасность:** Встроенная защита от CSRF-атак и XSS.

---

## Установка

1.  Перейдите в директорию `/local/components/` вашего проекта.
2.  Клонируйте репозиторий:
    ```bash
    git clone https://github.com/bxmeta/bitrix-form-handler-component.git victory
    ```
    *Ключевой момент здесь — `victory`. Мы клонируем репозиторий в папку с именем вендора, чтобы Битрикс мог корректно найти компонент по неймспейсу `victory:form.handler`.*

## Подключение на странице

Разместите вызов компонента на странице, где находится ваша форма.

**Пример вызова:**
```php
$APPLICATION->IncludeComponent(
	'victory:form.handler',
	'.default', // или ваш кастомный шаблон
	[
		// ... параметры ...
	]
);
```

---

## Параметры компонента

| Параметр             | Тип      | Описание                                                                                                                                                           |
|----------------------|----------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `STORAGE_TYPE`       | `список` | **Тип хранилища.** `iblock` — инфоблок, `highload` — Highload-блок.                                                                                                  |
| `IBLOCK_ID`          | `строка` | **ID инфоблока.** Указывается, если `STORAGE_TYPE` = `iblock`.                                                                                                       |
| `HLBLOCK_ID`         | `строка` | **ID Highload-блока.** Указывается, если `STORAGE_TYPE` = `highload`.                                                                                                |
| `EMAIL_TO`           | `строка` | **Email для уведомлений.** На этот адрес будут приходить письма о новых заявках. Если не указан, письма не отправляются.                                             |
| `USE_RECAPTCHA`      | `чекбокс`| **Использовать Google reCAPTCHA.** Включает проверку формы через сервис Google.                                                                                     |
| `RECAPTCHA_SITEKEY`  | `строка` | **Ключ сайта reCAPTCHA.** Публичный ключ для отображения виджета.                                                                                                    |
| `RECAPTCHA_SECRET`   | `строка` | **Секретный ключ reCAPTCHA.** Секретный ключ для проверки на стороне сервера.                                                                                        |
| `USE_SMARTCAPTCHA`   | `чекбокс`| **Использовать Yandex SmartCaptcha.** Включает проверку формы через сервис Яндекса.                                                                                |
| `SMARTCAPTCHA_SITEKEY`| `строка` | **Ключ сайта SmartCaptcha.** Публичный ключ для отображения виджета.                                                                                                 |
| `SMARTCAPTCHA_SECRET`| `строка` | **Секретный ключ SmartCaptcha.** Серверный ключ для проверки.                                                                                                        |
| `B24_WEBHOOK`        | `строка` | **Вебхук Bitrix24.** URL входящего вебхука для интеграции с CRM. Если не указан, интеграция отключается.                                                            |
| `B24_MODE`           | `список` | **Режим интеграции с B24.** `lead` — создавать лид, `deal` — создавать сделку.                                                                                     |
| `B24_FIELDS_MAPPING` | `текст`  | **Соответствие полей для B24.** JSON-строка, где `ключ` — системное имя поля в B24, а `значение` — атрибут `name` поля в вашей HTML-форме.                           |

---

## Настройка HTML-формы

Компонент автоматически генерирует уникальный ID для каждой формы, что позволяет размещать несколько форм на одной странице. В шаблоне (`template.php`) этот ID используется для связи HTML-элементов и JavaScript.

**Ключевые моменты:**
- **Класс формы:** Убедитесь, что у тега `<form>` есть класс `victory-form-handler`. ID для формы генерируется автоматически.
- **Поля инфоблока:**
  - Для стандартных полей элемента (название, детальный текст) используйте их системные имена: `name="NAME"`, `name="DETAIL_TEXT"`.
  - Для свойств инфоблока используйте формат `name="PROPERTY_CODE"`, где `CODE` — символьный код свойства. Например, `name="PROPERTY_PHONE"`.
- **Поля Highload-блока:**
  - Используйте пользовательские имена полей `UF_*`. Например, `name="UF_PHONE"`, `name="UF_CITY"`.

---

## Интеграция с Bitrix24

1.  В Bitrix24 перейдите в `Разработчикам` -> `Другое` -> `Входящие вебхуки`.
2.  Создайте вебхук с правами на **CRM**.
3.  Скопируйте URL вебхука и вставьте его в параметр `B24_WEBHOOK`.
4.  Настройте `B24_FIELDS_MAPPING`.

**Пример `B24_FIELDS_MAPPING`:**
```json
{
  "TITLE": "NAME",
  "NAME": "NAME",
  "PHONE": "PHONE",
  "EMAIL": "EMAIL",
  "COMMENTS": "MESSAGE",
  "UTM_SOURCE": "UTM_SOURCE"
}
```
В этом примере:
- Поле `TITLE` лида/сделки будет заполнено из поля формы `<input name="NAME">`.
- Поле `PHONE` лида/сделки будет заполнено из поля формы `<input name="PHONE">`.
- Поле `COMMENTS` (комментарий) будет заполнено из поля `<textarea name="MESSAGE">`.

---

## Кастомизация и расширение

Вы можете подключать свои обработчики на события, которые вызывает компонент.

- **`OnBeforeFormSave`** — срабатывает после валидации, но до сохранения данных. Позволяет изменить данные или добавить свою проверку.
- **`OnAfterFormSave`** — срабатывает после успешного сохранения данных. Позволяет выполнить дополнительные действия, например, отправить SMS.

### Обработка ошибок в событиях

Для прерывания вып��лнения и возврата ошибки на клиент, используйте исключение `\Victory\FormHandler\Lib\ValidationException`. Это позволит корректно отобразить ошибку пользователю.

**Пример обработчика в `init.php`:**
```php
// /local/php_interface/init.php

use Bitrix\Main\Event;
use Victory\FormHandler\Lib\ValidationException;

AddEventHandler('victory', 'OnBeforeFormSave', function(Event $event) {
    $arFields = $event->getParameter('FIELDS');
    $arParams = $event->getParameter('PARAMS');

    // Пример: проверяем, что в поле PHONE не менее 10 цифр
    $phone = preg_replace('/[^0-9]/', '', $arFields['PHONE']);
    if (strlen($phone) < 10) {
        // Выбрасываем исключение, которое будет поймано компонентом
        throw new ValidationException('Проверьте номер телефона.', ['PHONE' => 'Номер телефона слишком короткий']);
    }

    // Можно модифицировать поля перед сохранением
    // $arFields['PROPERTY_SOME_FIELD'] = 'новое значе��ие';
});
```

---

## Шаблон и JavaScript

- **HTML:** Основная разметка формы находится в `templates/.default/template.php`. Компонент автоматически генерирует уникальный ID для тега `<form>` и связанных с ним элементов (блок ошибок, капча).
- **JavaScript:** Логика отправки формы находится в `templates/.default/script.js`. Скрипт написан в виде класса `VictoryFormHandler`, который автоматически инициализируется для каждой формы на странице.
- **Ошибки:** Блок для вывода сообщений генерируется с уникальным ID (`<form_id>_errors`) и обрабатывается соответствующим экземпляром JS-класса.